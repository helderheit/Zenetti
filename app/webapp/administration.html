<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500">
    <link rel="stylesheet" type="text/css" href="style/style.css">
    <script src="js/lib/jquery-3.3.1.min.js" type="text/javascript"></script>
    <script src="js/api/api.js" type="text/javascript"></script>

    <title>Zenetti - Administration</title>

    </head>

    <body>
        <header></header>
        <script type="text/javascript">
            $("header").load( "templates/header_bar.html" );
        </script>
         <div class="editor-background" id="user-editor">
             <div class="editor">
                 <div class="border">
                     <div class="editor-label">Add User</div>
                     <div class="editor-grid">
                         <span>Username:</span><input id="username_in">
                         <span>Name:</span><input id="name_in">
                         <span>Password:</span><input id="password_in">
                         <span>Change Password:</span><div class ="checkbox" id="change_password_in"></div>
                         <span>Admin:</span><div class ="checkbox" id="admin_in"></div>
                     </div>
                     <div class="editor-button">
                         <button id="add_user_confirm_button">Add User</button>
                         <button id="cancel_button">Cancel</button>
                     </div>
                 </div>
            </div>
             <script>
                 $("#cancel_button").on("click",function(){
                     $("#user-editor").hide();
                 });
                 $("#add_user_confirm_button").on("click",function(){
                     console.log("Add User");
                     var username= $("#username_in").val();
                     var name = $("#name_in").val();
                     var password = $("#password_in").val();
                     var change_password = false;
                     if($("#change_password_in").hasClass("checked")){
                         change_password = true;
                     }
                     var admin = false;
                     if($("#admin_in").hasClass("checked")){
                         admin = true;
                     }
                     console.log(username, name, password, change_password, admin );
                     apiAddUser({"username":username, "name":name,"password":password, "change_password":change_password,"admin":admin},
                     function(){
                         console.log("added user");
                         $("#user-editor").hide();
                         loadUserData();
                     }, function(data){
                        console.log(data);
                     });
                 });
             </script>
         </div>
        <div class="page-content">

            <h2>Administration</h2>
            <div class="section">
                <div class="toolbar border">
                    <button id="add_user_button">Add User</button>
                    <script type="text/javascript">
                        $("#add_user_button").on("click", function(){
                             $("#user-editor").show();
                            //$("#editor-background").load( "templates/user_editor.html" );
                        });
                    </script>
                </div>
            </div>
            <div class="section">
                <div class="user-table border">
                    <span class="first-row">Username</span>
                    <span class="first-row">Name</span>
                    <span class="first-row">admin</span>
                    <span class="first-row">master</span>
                    <span class="first-row">change password</span>
                    <span class="first-row"></span>
                </div>
            </div>
            <script type = text/javascript>
                function removeUser(username){
                    console.log("remove",username);
                    var confirmBackground = $("<div></div>");
                    confirmBackground.addClass("editor-background");

                    var confirmBox = $("<div></div>");
                    confirmBox.addClass("confirmation");
                    confirmBackground.append(confirmBox);

                    var confirmContent = $("<div></div>");
                    confirmContent.addClass("border");
                    confirmContent.html("<div class='editor-label'>Remove User</div>" +
                        "<div class=\"editor-grid\">"+
                        "<span>Do you really want to remove the user "+username+"?</span>"+
                        "</div>");
                    var confirmButtons = $("<div></div>");
                     var confirmButton = $("<button></button>");
                    confirmButton.html("Remove");
                    confirmButtons.append(confirmButton);

                    var cancelButton = $("<button></button>");
                    cancelButton.html("Cancel");
                    confirmButtons.append(cancelButton);
                    confirmButtons.addClass("editor-button");
                    confirmContent.append(confirmButtons);
                    confirmBox.append(confirmContent);

                    $("body").append(confirmBackground);
                    confirmBackground.show();

                    cancelButton.on("click",function(){
                      confirmBackground.remove();
                    });

                    confirmButton.on("click", function(){
                        apiRemoveUser(username,function(){
                            confirmBackground.remove();
                            loadUserData();
                        },function () {
                            //TODO
                        })
                    });

                }


                function loadUserData() {
                    apiGetUsers(function (users) {
                        $(".user-data-item").remove();
                        for (var i in users) {
                            function createDataItem() {
                                var item = $("<span></span>");
                                item.addClass("user-data-item");
                                return item;
                            }
                            var dataItem = createDataItem();

                            dataItem.html(users[i].username);
                            $(".user-table").append(dataItem);
                            dataItem = createDataItem();
                            dataItem.html(users[i].name);
                            $(".user-table").append(dataItem);
                            dataItem = createDataItem();
                            dataItem.html(users[i].admin.toString());
                            $(".user-table").append(dataItem);
                            dataItem = createDataItem();
                            dataItem.html(users[i].master.toString());
                            $(".user-table").append(dataItem);
                            dataItem = createDataItem();
                            dataItem.html(users[i].change_password.toString());
                            $(".user-table").append(dataItem);
                            dataItem = createDataItem();
                            var buttons = "<button>Edit</button>"
                            if(!users[i].master){
                                buttons = buttons +"<button onClick='removeUser(\""+users[i].username+"\")'>Remove</button>";
                            }
                            dataItem.html(buttons);
                            $(".user-table").append(dataItem);
                        }
                    });
                }
                loadUserData();
            </script>

        </div>
        <script src="js/ui.js" type="text/javascript"></script>

    </body>
</html>
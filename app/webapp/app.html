<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500">
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <script src="js/lib/jquery.min.js" type="text/javascript"></script>
    <!--<script src="js/lib/mirador.min.js" type="text/javascript"></script>-->
    <link rel="stylesheet" type="text/css" href="css/mirador-combined.min.css">

    <script src="js/api/api.js" type="text/javascript"></script>
    <script src="js/api/collections.js" type="text/javascript"></script>

    <title>Zenetti</title>

    </head>

    <body>
        <header></header>
        <script type="text/javascript">
            $("header").load( "templates/header_bar.html" );
        </script>

        <div id="viewer"></div>

        <script src="js/lib/mirador.min.js"></script>
        <script type="text/javascript">

        var myMiradorInstance;


        var test_key;
        var test_value;

        function create_annotation(self, new_annotation){
            console.log("annotation created");
            // value
            console.log(new_annotation);
            test_value = new_annotation;
            // key
            console.log(new_annotation.on[0].full);
            test_key = new_annotation.on[0].full;
        }

        function update_annotation(self, new_annotation){
            console.log("annotation update");
            console.log(new_annotation);
        }

        var open_windows = []
        function add_window(self, data){
            open_windows.push(data.id)
            //console.log(self);
            console.log("window added: " + data.id);

            try {
                myMiradorInstance.eventEmitter.subscribe('annotationCreated.'+data.id, create_annotation);
                myMiradorInstance.eventEmitter.subscribe('annotationUpdated.'+data.id, update_annotation);
                console.log("annotation listener added");
            }
            catch (e) {
               console.log(e);
            }


            //myMiradorInstance.eventEmitter.subscribe('annotationUpdated.[data.id]', update_annotation);
        }

        function remove_window(self, window_id){
            console.log("window removed: " + window_id);
            var index = open_windows.indexOf(window_id);
            if (index > -1) {
                open_windows.splice(index, 1);
            }
        }

        // für jede Seite eines Albums wird ein key in den local storage gespeichert (key ist für alle annotationen auf
        // der Seite gleich und kann in der Rückgabe des "new annotation events" ausgelesen werden); Der dazugehörige
        // value ist ein stringified array aller annotationsobjekte
        function write_storage(){
            console.log("set storage");
            var list = [];
            if(test_key && test_value){
                list.push(test_value);
                localStorage.setItem(test_key, JSON.stringify(list));
            }
        }

        var collectionId = '2fc86d90-9633-4e9a-9297-664f3c9723c5';
        apiGetCollection(collectionId, function(collection){
            var manifestUris = []
            for(var i in collection["items"]){

                manifestUris.push(
                 { "manifestUri": "http://localhost:4000/data/"+collectionId+"/"+collection["items"][i], "location": "University of Regensburg"}
                );
            }

            myMiradorInstance = new Mirador({
                "id": "viewer",
             "layout": "1x1",
             "buildPath": "",
             "data": manifestUris,
            "windowObjects": [{
               loadedManifest: "",
               viewType: "ImageView"
             }],
             "annotationEndpoint": { "name":"Local Storage", "module": "LocalStorageEndpoint" },
             "windowSettings": {
               "canvasControls": { // The types of controls available to be displayed on a canvas
                 "imageManipulation" : {
                   "manipulationLayer" : true,
                   "controls" : {
                     "mirror" : true
                   }
                 }
               }
             }
            });

            myMiradorInstance.eventEmitter.subscribe('windowAdded', add_window);
            myMiradorInstance.eventEmitter.subscribe('windowRemoved', remove_window);

       },function(){});

        </script>

    </body>
</html>
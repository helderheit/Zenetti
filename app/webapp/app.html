<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500">
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <script src="js/lib/jquery.min.js" type="text/javascript"></script>
    <!--<script src="js/lib/mirador.min.js" type="text/javascript"></script>-->
    <link rel="stylesheet" type="text/css" href="css/mirador-combined.min.css">

    <script src="js/api/api.js" type="text/javascript"></script>
    <script src="js/api/collections.js" type="text/javascript"></script>

    <title>Zenetti</title>

    </head>

    <body>
        <header></header>
        <script type="text/javascript">
            $("header").load( "templates/header_bar.html" );
        </script>

        <div id="viewer"></div>

        <div id="metadata">
            <span style="width: 100%;padding: 0;margin: 0;">
                <button class="metadata-btn active" id="btn-album" onclick="disp_album_data()">Album</button>
                <button class="metadata-btn" id="btn-page" onclick="disp_page_data()">Page</button>
            </span>
            <div id="metadata-content">
                <div id="metadata-content-container"></div>
            </div>
            <button id="metadata-edit">Edit <img src="data/Logo/add_comment-white-18dp/1x/round_add_comment_white_18dp.png"/></button>
        </div>
        <script>
            var btnContainer = document.getElementById("metadata");
            var btns = btnContainer.getElementsByClassName("metadata-btn");
            for (var i = 0; i < btns.length; i++) {
              btns[i].addEventListener("click", function() {
                var current = document.getElementsByClassName("active");
                current[0].className = current[0].className.replace("active", "");
                this.className += " active";
              });
            }

            var no_meta_disp = true;

            if(no_meta_disp){
                var manifest_source = "http://localhost:4000/manifests/album_02.json";
                $.getJSON(manifest_source, function(data) {
                    content = "";
                    for(var i = 0; i < (data.metadata).length; i++) {
                        var label = (data.metadata)[i].label;
                        var value = (data.metadata)[i].value;
                        content = content + "<b>" + label + "</b>" + "<br>" + value + "<br>" + "<br>";
                        //console.log(content);
                    }
                    document.getElementById("metadata-content-container").innerHTML = content;
                });
            }

            function disp_album_data() {
                var manifest_source = "http://localhost:4000/manifests/album_02.json";
                $.getJSON(manifest_source, function(data) {
                    content = "";
                    for(var i = 0; i < (data.metadata).length; i++) {
                        var label = (data.metadata)[i].label;
                        var value = (data.metadata)[i].value;
                        content = content + "<b>" + label + "</b>" + "<br>" + value + "<br>" + "<br>";
                        //console.log(content);
                    }
                    document.getElementById("metadata-content-container").innerHTML = content;
                });
                no_meta_disp = false;
            }
            function disp_page_data() {
                document.getElementById("metadata-content-container").innerHTML = "";
                no_meta_disp = false;
            }
        </script>
        <!--
        <script>
            var myLocalStorage = localStorage.getItem('http://localhost:4000/data/Zenetti_Tagebuecher/Album_01/ubr2008000093.json');
            document.getElementById('metadata').innerHTML += myLocalStorage;
        </script>
        -->

        <script src="js/lib/mirador.min.js"></script>
        <script type="text/javascript">

        var myMiradorInstance;

        function create_annotation(self, new_annotation){
            console.log("annotation created");
            console.log(new_annotation);
        }

        function update_annotation(self, new_annotation){
            console.log("annotation update");
            console.log(new_annotation);
        }

        var open_windows = []
        function add_window(self, data){
            open_windows.push(data.id)
            //console.log(self);
            console.log("window added: " + data.id);

            try {
                myMiradorInstance.eventEmitter.subscribe('annotationCreated.'+data.id, create_annotation);
                myMiradorInstance.eventEmitter.subscribe('annotationUpdated.'+data.id, update_annotation);
                console.log("annotation listener added");
            }
            catch (e) {
               console.log(e);
            }


            //myMiradorInstance.eventEmitter.subscribe('annotationUpdated.[data.id]', update_annotation);
        }

        function remove_window(self, window_id){
            console.log("window removed: " + window_id);
            var index = open_windows.indexOf(window_id);
            if (index > -1) {
                open_windows.splice(index, 1);
            }
        }

        var collectionId = '16a63fe0-54ec-4cc9-884c-39a689d03894';
        apiGetCollection(collectionId, function(collection){
            var manifestUris = []
            for(var i in collection["items"]){

                manifestUris.push(
                 { "manifestUri": "http://localhost:4000/data/"+collectionId+"/"+collection["items"][i], "location": "University of Regensburg"}
                );
            }

            myMiradorInstance = new Mirador({
                "id": "viewer",
             "layout": "1x1",
             "buildPath": "",
             "data": manifestUris,
            "windowObjects": [{
               loadedManifest: "",
               viewType: "ImageView"
             }],
             "annotationEndpoint": { "name":"Local Storage", "module": "LocalStorageEndpoint" },
             "windowSettings": {
               "canvasControls": { // The types of controls available to be displayed on a canvas
                 "imageManipulation" : {
                   "manipulationLayer" : true,
                   "controls" : {
                     "mirror" : true
                   }
                 }
               }
             },
             "sidePanelOptions" : {
               "tocTabAvailable": true,
               "layersTabAvailable": true,
               "searchTabAvailable": true
             }
            });

            myMiradorInstance.eventEmitter.subscribe('windowAdded', add_window);
            myMiradorInstance.eventEmitter.subscribe('windowRemoved', remove_window);

       },function(){});

        </script>

    </body>
</html>